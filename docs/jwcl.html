<!DOCTYPE html>

<html>
<head>
  <title>jwcl.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>jwcl.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">type</span> Hex = <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">type</span> Op = <span class="hljs-string">'encrypt'</span> | <span class="hljs-string">'decrypt'</span> | <span class="hljs-string">'sign'</span> | <span class="hljs-string">'verify'</span>;

<span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params"></span>) =&gt; {


</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="crypto-constants">Crypto Constants</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">const</span> AES_BLOCK_SIZE_BYTES = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">const</span> AES_IV_SIZE = AES_BLOCK_SIZE_BYTES;
    <span class="hljs-keyword">const</span> AUTH_TAG_SIZE_BYTES = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">const</span> BITS_IN_BYTE = <span class="hljs-number">8</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="crypto-defaults">Crypto Defaults</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">const</span> PRIVATE_KEY_LENGTH_BITS = <span class="hljs-number">128</span>;
    <span class="hljs-keyword">const</span> PRIVATE_KEY_LENGTH_BYTES = PRIVATE_KEY_LENGTH_BITS/BITS_IN_BYTE;
    <span class="hljs-keyword">const</span> PBKDF2_ITERATIONS = <span class="hljs-number">10000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO remove  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> NOT_IMPLEMENTED = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">throw</span> {
            name: <span class="hljs-string">'JWCL'</span>,
            message: <span class="hljs-string">'not implemented'</span>
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h1 id="browser">Browser</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">const</span> browser = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            
        <span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">window</span>.crypto;
        <span class="hljs-keyword">const</span> subtle = <span class="hljs-built_in">window</span>.crypto.subtle;    

        <span class="hljs-keyword">const</span> hexReg = <span class="hljs-regexp">/[a-f0-9][a-f0-9]/g</span>;
        <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> TextEncoder(<span class="hljs-string">'utf-8'</span>);
        <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> TextDecoder(<span class="hljs-string">'utf-8'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="internal">Internal</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> stob = (<span class="hljs-built_in">string</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">Uint8Array</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> encoder.encode(<span class="hljs-built_in">string</span>);
        };

        <span class="hljs-keyword">const</span> btos = (binary: <span class="hljs-built_in">ArrayBuffer</span> | ArrayBufferView): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> binaryArray = (binary <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">ArrayBuffer</span>) ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(binary) : binary;
            <span class="hljs-keyword">return</span> decoder.decode(binaryArray);
        };
     
        <span class="hljs-keyword">const</span> byteToHex = (_byte: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> hex = _byte.toString(<span class="hljs-number">16</span>);
            <span class="hljs-keyword">return</span> (hex.length === <span class="hljs-number">1</span> ? <span class="hljs-string">'0'</span> : <span class="hljs-string">''</span>) + hex;
        };
     
        <span class="hljs-keyword">const</span> btoh = (binary: <span class="hljs-built_in">ArrayBuffer</span> | <span class="hljs-built_in">Uint8Array</span>): <span class="hljs-function"><span class="hljs-params">Hex</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> binaryArray = (binary <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">ArrayBuffer</span>) ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(binary) : binary;
            <span class="hljs-keyword">return</span> binaryArray.reduce( <span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> acc + byteToHex(val), <span class="hljs-string">''</span>);
        };
     
        <span class="hljs-keyword">const</span> htob = (hex: Hex): <span class="hljs-function"><span class="hljs-params">Uint8Array</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> hexArray = hex.match(hexReg);
            <span class="hljs-keyword">if</span> (!hexArray) {
                <span class="hljs-keyword">throw</span> {
                    name: <span class="hljs-string">'JWCL'</span>,
                    message: <span class="hljs-string">'jwcl._internal.htob input is not hex'</span>
                };
            }
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Uint8Array</span>.from(hexArray.map(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-built_in">Number</span>.parseInt(val, <span class="hljs-number">16</span>)));
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="crypto-defaults">Crypto Defaults</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> HASH = <span class="hljs-string">'SHA-256'</span>;
        <span class="hljs-keyword">const</span> AES = <span class="hljs-string">'AES-GCM'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="private-key">Private Key</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="key">Key</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> privateKey = <span class="hljs-keyword">async</span> (op?: Op): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">if</span> (!op) {
                <span class="hljs-keyword">return</span> random(PRIVATE_KEY_LENGTH_BYTES);
            } 
            <span class="hljs-keyword">let</span> cryptoKey;
            <span class="hljs-keyword">if</span> (op === <span class="hljs-string">'encrypt'</span> || op === <span class="hljs-string">'decrypt'</span>) {
                cryptoKey = <span class="hljs-keyword">await</span> subtle.generateKey({
                    name: AES,
                    length: PRIVATE_KEY_LENGTH_BITS
                }, <span class="hljs-literal">true</span>, [<span class="hljs-string">'encrypt'</span>, <span class="hljs-string">'decrypt'</span>]);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op === <span class="hljs-string">'sign'</span> || op === <span class="hljs-string">'verify'</span>) {
                cryptoKey = <span class="hljs-keyword">await</span> subtle.generateKey({
                    name: <span class="hljs-string">'HMAC'</span>,
                    hash: HASH
                }, <span class="hljs-literal">true</span>, [<span class="hljs-string">'sign'</span>,<span class="hljs-string">'verify'</span>]);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> {
                    name: <span class="hljs-string">'JWCL'</span>,
                    message: <span class="hljs-string">`jwcl.private.key <span class="hljs-subst">${op}</span> is not a supported operation`</span>
                };
            }
            <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">await</span> subtle.exportKey(<span class="hljs-string">'raw'</span>, cryptoKey);
            <span class="hljs-keyword">return</span> btoh(key);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="kdf">Kdf</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> privateKdf = <span class="hljs-keyword">async</span> (secret: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> masterKey = <span class="hljs-keyword">await</span> subtle.importKey(<span class="hljs-string">'raw'</span>, stob(secret), { 
                name: <span class="hljs-string">'PBKDF2'</span> 
            }, <span class="hljs-literal">false</span>, [<span class="hljs-string">'deriveKey'</span>]);
            <span class="hljs-keyword">const</span> derivedKey = <span class="hljs-keyword">await</span> subtle.deriveKey({ 
                <span class="hljs-string">'name'</span>: <span class="hljs-string">'PBKDF2'</span>,
                <span class="hljs-string">'salt'</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>([<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]), <span class="hljs-comment">// TODO research this</span>
                <span class="hljs-string">'iterations'</span>: PBKDF2_ITERATIONS,
                <span class="hljs-string">'hash'</span>: HASH
            }, masterKey, { 
                <span class="hljs-string">'name'</span>: AES, 
                <span class="hljs-string">'length'</span>: PRIVATE_KEY_LENGTH_BITS 
            }, <span class="hljs-literal">true</span>, [ <span class="hljs-string">'encrypt'</span>, <span class="hljs-string">'decrypt'</span> ]);
            <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">await</span> subtle.exportKey(<span class="hljs-string">'raw'</span>, derivedKey);
            <span class="hljs-keyword">return</span> btoh(key);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="encrypt">Encrypt</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> privateEncrypt = <span class="hljs-keyword">async</span> (key: Hex, plaintext: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> iv = <span class="hljs-keyword">await</span> random(AES_IV_SIZE);
            <span class="hljs-keyword">const</span> algorithm = {
                name: AES,
                iv: htob(iv)
            };
            <span class="hljs-keyword">const</span> cryptoKey = <span class="hljs-keyword">await</span> subtle.importKey(<span class="hljs-string">'raw'</span>, htob(key), algorithm, <span class="hljs-literal">false</span>, [<span class="hljs-string">'encrypt'</span>]);
            <span class="hljs-keyword">const</span> ciphertext = <span class="hljs-keyword">await</span> subtle.encrypt(algorithm, cryptoKey, stob(plaintext));
            <span class="hljs-keyword">return</span> iv + btoh(ciphertext);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="decrypt">Decrypt</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        
        <span class="hljs-keyword">const</span> privateDecrypt = <span class="hljs-keyword">async</span> (key: Hex, ciphertext: Hex): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
            <span class="hljs-keyword">const</span> binaryCiphertext = htob(ciphertext);
            <span class="hljs-keyword">const</span> algorithm = {
                name: AES,
                iv: binaryCiphertext.subarray(<span class="hljs-number">0</span>, AES_IV_SIZE)
            };
            <span class="hljs-keyword">const</span> cryptoKey = <span class="hljs-keyword">await</span> subtle.importKey(<span class="hljs-string">'raw'</span>, htob(key), algorithm, <span class="hljs-literal">false</span>, [<span class="hljs-string">'decrypt'</span>]);
            <span class="hljs-keyword">const</span> plaintext = <span class="hljs-keyword">await</span> subtle.decrypt(algorithm, cryptoKey, binaryCiphertext.subarray(AES_IV_SIZE));
            <span class="hljs-keyword">return</span> btos(plaintext);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="sign">Sign</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>     
        <span class="hljs-keyword">const</span> privateSign = <span class="hljs-keyword">async</span> (key: Hex, plaintext: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> algorithm = {
                name: <span class="hljs-string">'HMAC'</span>,
                hash: HASH
            };
            <span class="hljs-keyword">const</span> cryptoKey = <span class="hljs-keyword">await</span> subtle.importKey(<span class="hljs-string">'raw'</span>, htob(key), algorithm, <span class="hljs-literal">false</span>, [<span class="hljs-string">'sign'</span>]);
            <span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> subtle.sign(algorithm.name, cryptoKey, stob(plaintext));
            <span class="hljs-keyword">return</span> btoh(signature);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="verify">Verify</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        
        <span class="hljs-keyword">const</span> privateVerify = <span class="hljs-keyword">async</span> (key: Hex, signature: Hex, plaintext: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
            <span class="hljs-keyword">const</span> algorithm = {
                name: <span class="hljs-string">'HMAC'</span>,
                hash: HASH
            };
            <span class="hljs-keyword">const</span> cryptoKey = <span class="hljs-keyword">await</span> subtle.importKey(<span class="hljs-string">'raw'</span>, htob(key), algorithm, <span class="hljs-literal">false</span>, [<span class="hljs-string">'verify'</span>]);
            <span class="hljs-keyword">return</span> subtle.verify(algorithm.name, cryptoKey, htob(signature), stob(plaintext));
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="random">Random</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> random = <span class="hljs-keyword">async</span> (bytes: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> output = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(bytes);
            crypto.getRandomValues(output);
            <span class="hljs-keyword">return</span> btoh(output);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="hash">Hash</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">async</span> (plaintext: <span class="hljs-built_in">string</span>, algorithm: <span class="hljs-built_in">string</span> = HASH): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> subtle.digest(algorithm, stob(plaintext));
            <span class="hljs-keyword">return</span> btoh(hash);    
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="export">Export</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">return</span> {
            _internal: {
                stob: stob,
                btos: btos,
                byteToHex: byteToHex,
                btoh: btoh,
                htob: htob
            },
            <span class="hljs-keyword">private</span>: {
                key: privateKey,
                kdf: privateKdf, 
                encrypt: privateEncrypt,
                decrypt: privateDecrypt,
                sign: privateSign,
                verify: privateVerify
            },
            <span class="hljs-keyword">public</span>: {
                key: NOT_IMPLEMENTED, 
                encrypt: NOT_IMPLEMENTED,
                decrypt: NOT_IMPLEMENTED,
                sign: NOT_IMPLEMENTED,
                verify: NOT_IMPLEMENTED
            },
            random: random,
            hash: hash
        };
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h1 id="node">Node</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">const</span> node = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {

        <span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="crypto-defaults">Crypto Defaults</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> HASH = <span class="hljs-string">'sha256'</span>;
        <span class="hljs-keyword">const</span> AES = <span class="hljs-string">'id-aes128-GCM'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="private-key">Private Key</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="key">Key</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> privateKey = <span class="hljs-keyword">async</span> (op?: Op): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">if</span> (op &amp;&amp; !([<span class="hljs-string">'encrypt'</span>, <span class="hljs-string">'decrypt'</span>, <span class="hljs-string">'sign'</span>, <span class="hljs-string">'verify'</span>].includes(op))) {
                <span class="hljs-keyword">throw</span> {
                    name: <span class="hljs-string">'JWCL'</span>,
                    message: <span class="hljs-string">`jwcl.private.key <span class="hljs-subst">${op}</span> is not a supported operation`</span>
                };
            }
            <span class="hljs-keyword">return</span> random(PRIVATE_KEY_LENGTH_BYTES);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="kdf">Kdf</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        
        <span class="hljs-keyword">const</span> privateKdf = <span class="hljs-keyword">async</span> (secret: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;Hex&gt;<span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params">resolve, reject</span>) =&gt; {
                crypto.pbkdf2(<span class="hljs-params">
                    secret, 
                    Buffer.<span class="hljs-keyword">from</span>(<span class="hljs-params">[0,0,0,0,0,0,0,0]</span>).toString(<span class="hljs-params">'utf8'</span>), 
                    PBKDF2_ITERATIONS, 
                    PRIVATE_KEY_LENGTH_BYTES, 
                    HASH, 
                    (<span class="hljs-params">err: <span class="hljs-built_in">Error</span>, buffer: Buffer</span>) =&gt; {
                        <span class="hljs-keyword">if</span> (<span class="hljs-params">err</span>) {
                            reject(<span class="hljs-params">err</span>);
                        } <span class="hljs-keyword">else</span> {
                            resolve(<span class="hljs-params">buffer.toString(<span class="hljs-params">'hex'</span>)</span>);
                        }
                    }
                </span>);
            }</span>);
        };

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="encrypt">Encrypt</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> privateEncrypt = <span class="hljs-keyword">async</span> (key: Hex, plaintext: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> iv = <span class="hljs-keyword">await</span> random(AES_IV_SIZE);
            <span class="hljs-keyword">const</span> cipher = crypto.createCipheriv(AES, Buffer.from(key, <span class="hljs-string">'hex'</span>), Buffer.from(iv, <span class="hljs-string">'hex'</span>));
            <span class="hljs-keyword">const</span> ciphertext = iv + cipher.update(plaintext, <span class="hljs-string">'utf8'</span>, <span class="hljs-string">'hex'</span>) + cipher.final(<span class="hljs-string">'hex'</span>);
            <span class="hljs-keyword">return</span> ciphertext + cipher.getAuthTag().toString(<span class="hljs-string">'hex'</span>);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="decrypt">Decrypt</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>times 2 for hex</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> privateDecrypt = <span class="hljs-keyword">async</span> (key: Hex, ciphertext: Hex): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
            <span class="hljs-keyword">const</span> length = ciphertext.length;
            <span class="hljs-keyword">const</span> iv = ciphertext.substring(<span class="hljs-number">0</span>, AES_IV_SIZE * <span class="hljs-number">2</span>);
            <span class="hljs-keyword">const</span> ciphertext_ = ciphertext.substring(AES_IV_SIZE * <span class="hljs-number">2</span>, length - (AUTH_TAG_SIZE_BYTES * <span class="hljs-number">2</span>));
            <span class="hljs-keyword">const</span> authTag = ciphertext.substring(length - (AUTH_TAG_SIZE_BYTES * <span class="hljs-number">2</span>), length);
            <span class="hljs-keyword">const</span> decipher = crypto.createDecipheriv(AES, Buffer.from(key, <span class="hljs-string">'hex'</span>), Buffer.from(iv, <span class="hljs-string">'hex'</span>));
            decipher.setAuthTag(Buffer.from(authTag, <span class="hljs-string">'hex'</span>));
            <span class="hljs-keyword">return</span> decipher.update(ciphertext_, <span class="hljs-string">'hex'</span>, <span class="hljs-string">'utf8'</span>) + decipher.final(<span class="hljs-string">'utf8'</span>);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="sign">Sign</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>     
        <span class="hljs-keyword">const</span> privateSign = <span class="hljs-keyword">async</span> (key: Hex, plaintext: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> hmac = crypto.createHmac(HASH, Buffer.from(key, <span class="hljs-string">'hex'</span>));
            hmac.update(plaintext);
            <span class="hljs-keyword">return</span> hmac.digest(<span class="hljs-string">'hex'</span>);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="verify">Verify</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        
        <span class="hljs-keyword">const</span> privateVerify = <span class="hljs-keyword">async</span> (key: Hex, signature: Hex, plaintext: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
            <span class="hljs-keyword">const</span> hmac = crypto.createHmac(HASH, Buffer.from(key, <span class="hljs-string">'hex'</span>));
            hmac.update(plaintext);
            <span class="hljs-keyword">return</span> hmac.digest(<span class="hljs-string">'hex'</span>)
                .split(<span class="hljs-string">''</span>)
                .map(<span class="hljs-function">(<span class="hljs-params">c: <span class="hljs-built_in">string</span>, i: <span class="hljs-built_in">number</span></span>) =&gt;</span> c === signature[i])
                .reduce(<span class="hljs-function">(<span class="hljs-params">x: <span class="hljs-built_in">boolean</span>, y: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> {
                    <span class="hljs-keyword">return</span> x &amp;&amp; y;
                }, <span class="hljs-literal">true</span>);
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="random">Random</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> random = (bytes: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;Hex&gt;<span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params">resolve, reject</span>) =&gt; {
                crypto.randomBytes(<span class="hljs-params">bytes, (<span class="hljs-params">err: <span class="hljs-built_in">Error</span>, buffer: Buffer</span>) =&gt; {
                    <span class="hljs-keyword">if</span> (<span class="hljs-params">err</span>) {
                        reject(<span class="hljs-params">err</span>);
                    } <span class="hljs-keyword">else</span> {
                        resolve(<span class="hljs-params">buffer.toString(<span class="hljs-params">'hex'</span>)</span>);
                    }
                }</span>);
            }</span>);
        };
 
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h2 id="hash">Hash</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">async</span> (plaintext: <span class="hljs-built_in">string</span>, algorithm: <span class="hljs-built_in">string</span> = HASH): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
            <span class="hljs-keyword">const</span> hash = crypto.createHash(algorithm);
            hash.update(plaintext);
            <span class="hljs-keyword">return</span> hash.digest(<span class="hljs-string">'hex'</span>);
        };

        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-keyword">private</span>: {
                key: privateKey, 
                kdf: privateKdf, 
                encrypt: privateEncrypt, 
                decrypt: privateDecrypt, 
                sign: privateSign, 
                verify: privateVerify
            },
            <span class="hljs-keyword">public</span>: {
                key: NOT_IMPLEMENTED, 
                encrypt: NOT_IMPLEMENTED,
                decrypt: NOT_IMPLEMENTED,
                sign: NOT_IMPLEMENTED,
                verify: NOT_IMPLEMENTED
            },
            random: random, 
            hash: hash
        };
    };

    <span class="hljs-keyword">const</span> env = <span class="hljs-function">(<span class="hljs-params">(<span class="hljs-params"></span>) =&gt; (<span class="hljs-params"><span class="hljs-keyword">typeof</span> <span class="hljs-built_in">module</span> !== '<span class="hljs-literal">undefined</span>' &amp;&amp; <span class="hljs-built_in">module</span>.exports</span>) ? 'node' : 'browser'</span>)<span class="hljs-params">()</span>;
    
    <span class="hljs-params">const</span> _<span class="hljs-params">jwcl</span> = <span class="hljs-params">env</span> === '<span class="hljs-params">browser</span>' ? <span class="hljs-params">browser</span><span class="hljs-params">()</span> : <span class="hljs-params">node</span><span class="hljs-params">()</span>;

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="encrypt">Encrypt</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>        
    <span class="hljs-keyword">const</span> encrypt = <span class="hljs-keyword">async</span> (secret: <span class="hljs-built_in">string</span>, message: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
        <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">await</span> _jwcl.private.kdf(secret);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _jwcl.private.encrypt(key, message);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h2 id="decrypt">Decrypt</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">const</span> decrypt = <span class="hljs-keyword">async</span> (secret: <span class="hljs-built_in">string</span>, encryptedMessage: Hex): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
        <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">await</span> _jwcl.private.kdf(secret);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _jwcl.private.decrypt(key, encryptedMessage);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h2 id="sign">Sign</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">const</span> sign = <span class="hljs-keyword">async</span> (secret: <span class="hljs-built_in">string</span>, message: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Hex&gt; =&gt; {
        <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">await</span> _jwcl.private.kdf(secret);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _jwcl.private.sign(key, message);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h2 id="verify">Verify</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">const</span> verify = <span class="hljs-keyword">async</span> (secret: <span class="hljs-built_in">string</span>, signature: Hex, message: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
        <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">await</span> _jwcl.private.kdf(secret);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _jwcl.private.verify(key, signature, message);
    };

    <span class="hljs-keyword">const</span> jwcl = <span class="hljs-built_in">Object</span>.assign({}, _jwcl, {
        encrypt: encrypt,
        decrypt: decrypt,
        sign: sign,
        verify: verify        
    });

    <span class="hljs-keyword">if</span> (env === <span class="hljs-string">'browser'</span>) {
        <span class="hljs-keyword">this</span>.jwcl = jwcl;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (env === <span class="hljs-string">'node'</span>) {
        exports.jwcl = jwcl;
    }

}).call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
